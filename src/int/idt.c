#include <int/idt.h>
#include <int/isr.h>
#include <sys/smp.h>
#include <io/ports.h>

#define shift(v, n)				((v) << (n))
#define pack_flags(T, DPL, P)	(0x00 | shift(T & 0b1111, 0) | shift(DPL & 0b11, 5) | shift(P & 0b1, 7))

#define SET_GATE(num, func)		idt_set_gate(num, (uint32_t)func, DESC_SEG(DESC_KERNEL_CODE, PL_RING0), pack_flags(0xE, PL_RING3, 0b1))
#define SET_GATE_ISR(num)		SET_GATE(num, isr##num)

extern void idt_flush(uint32_t);
extern int_handler_t handlers[IDT_ENTRIES];

void idt_set_gate(uint8_t num, uint32_t base, uint16_t sel, uint8_t flags) {
	core_locals_t* locals = get_core_locals();

	locals->idt_entries[num].base_low	= (base & 0xFFFF);
	locals->idt_entries[num].base_high	= (base >> 16) & 0xFFFF;

	locals->idt_entries[num].sel		= sel;
	locals->idt_entries[num].always0	= 0;

	locals->idt_entries[num].flags		= flags | 0x60;
}

void idt_init() {
	SET_GATE_ISR(0);
	SET_GATE_ISR(1);
	SET_GATE_ISR(2);
	SET_GATE_ISR(3);
	SET_GATE_ISR(4);
	SET_GATE_ISR(5);
	SET_GATE_ISR(6);
	SET_GATE_ISR(7);
	SET_GATE_ISR(8);
	SET_GATE_ISR(9);
	SET_GATE_ISR(10);
	SET_GATE_ISR(11);
	SET_GATE_ISR(12);
	SET_GATE_ISR(13);
	SET_GATE_ISR(14);
	SET_GATE_ISR(15);
	SET_GATE_ISR(16);
	SET_GATE_ISR(17);
	SET_GATE_ISR(18);
	SET_GATE_ISR(19);
	SET_GATE_ISR(20);
	SET_GATE_ISR(21);
	SET_GATE_ISR(22);
	SET_GATE_ISR(23);
	SET_GATE_ISR(24);
	SET_GATE_ISR(25);
	SET_GATE_ISR(26);
	SET_GATE_ISR(27);
	SET_GATE_ISR(28);
	SET_GATE_ISR(29);
	SET_GATE_ISR(30);
	SET_GATE_ISR(31);
	SET_GATE_ISR(32);
	SET_GATE_ISR(33);
	SET_GATE_ISR(34);
	SET_GATE_ISR(35);
	SET_GATE_ISR(36);
	SET_GATE_ISR(37);
	SET_GATE_ISR(38);
	SET_GATE_ISR(39);
	SET_GATE_ISR(40);
	SET_GATE_ISR(41);
	SET_GATE_ISR(42);
	SET_GATE_ISR(43);
	SET_GATE_ISR(44);
	SET_GATE_ISR(45);
	SET_GATE_ISR(46);
	SET_GATE_ISR(47);
	SET_GATE_ISR(48);
	SET_GATE_ISR(49);
	SET_GATE_ISR(50);
	SET_GATE_ISR(51);
	SET_GATE_ISR(52);
	SET_GATE_ISR(53);
	SET_GATE_ISR(54);
	SET_GATE_ISR(55);
	SET_GATE_ISR(56);
	SET_GATE_ISR(57);
	SET_GATE_ISR(58);
	SET_GATE_ISR(59);
	SET_GATE_ISR(60);
	SET_GATE_ISR(61);
	SET_GATE_ISR(62);
	SET_GATE_ISR(63);
	SET_GATE_ISR(64);
	SET_GATE_ISR(65);
	SET_GATE_ISR(66);
	SET_GATE_ISR(67);
	SET_GATE_ISR(68);
	SET_GATE_ISR(69);
	SET_GATE_ISR(70);
	SET_GATE_ISR(71);
	SET_GATE_ISR(72);
	SET_GATE_ISR(73);
	SET_GATE_ISR(74);
	SET_GATE_ISR(75);
	SET_GATE_ISR(76);
	SET_GATE_ISR(77);
	SET_GATE_ISR(78);
	SET_GATE_ISR(79);
	SET_GATE_ISR(80);
	SET_GATE_ISR(81);
	SET_GATE_ISR(82);
	SET_GATE_ISR(83);
	SET_GATE_ISR(84);
	SET_GATE_ISR(85);
	SET_GATE_ISR(86);
	SET_GATE_ISR(87);
	SET_GATE_ISR(88);
	SET_GATE_ISR(89);
	SET_GATE_ISR(90);
	SET_GATE_ISR(91);
	SET_GATE_ISR(92);
	SET_GATE_ISR(93);
	SET_GATE_ISR(94);
	SET_GATE_ISR(95);
	SET_GATE_ISR(96);
	SET_GATE_ISR(97);
	SET_GATE_ISR(98);
	SET_GATE_ISR(99);
	SET_GATE_ISR(100);
	SET_GATE_ISR(101);
	SET_GATE_ISR(102);
	SET_GATE_ISR(103);
	SET_GATE_ISR(104);
	SET_GATE_ISR(105);
	SET_GATE_ISR(106);
	SET_GATE_ISR(107);
	SET_GATE_ISR(108);
	SET_GATE_ISR(109);
	SET_GATE_ISR(110);
	SET_GATE_ISR(111);
	SET_GATE_ISR(112);
	SET_GATE_ISR(113);
	SET_GATE_ISR(114);
	SET_GATE_ISR(115);
	SET_GATE_ISR(116);
	SET_GATE_ISR(117);
	SET_GATE_ISR(118);
	SET_GATE_ISR(119);
	SET_GATE_ISR(120);
	SET_GATE_ISR(121);
	SET_GATE_ISR(122);
	SET_GATE_ISR(123);
	SET_GATE_ISR(124);
	SET_GATE_ISR(125);
	SET_GATE_ISR(126);
	SET_GATE_ISR(127);
	SET_GATE_ISR(128);
	SET_GATE_ISR(129);
	SET_GATE_ISR(130);
	SET_GATE_ISR(131);
	SET_GATE_ISR(132);
	SET_GATE_ISR(133);
	SET_GATE_ISR(134);
	SET_GATE_ISR(135);
	SET_GATE_ISR(136);
	SET_GATE_ISR(137);
	SET_GATE_ISR(138);
	SET_GATE_ISR(139);
	SET_GATE_ISR(140);
	SET_GATE_ISR(141);
	SET_GATE_ISR(142);
	SET_GATE_ISR(143);
	SET_GATE_ISR(144);
	SET_GATE_ISR(145);
	SET_GATE_ISR(146);
	SET_GATE_ISR(147);
	SET_GATE_ISR(148);
	SET_GATE_ISR(149);
	SET_GATE_ISR(150);
	SET_GATE_ISR(151);
	SET_GATE_ISR(152);
	SET_GATE_ISR(153);
	SET_GATE_ISR(154);
	SET_GATE_ISR(155);
	SET_GATE_ISR(156);
	SET_GATE_ISR(157);
	SET_GATE_ISR(158);
	SET_GATE_ISR(159);
	SET_GATE_ISR(160);
	SET_GATE_ISR(161);
	SET_GATE_ISR(162);
	SET_GATE_ISR(163);
	SET_GATE_ISR(164);
	SET_GATE_ISR(165);
	SET_GATE_ISR(166);
	SET_GATE_ISR(167);
	SET_GATE_ISR(168);
	SET_GATE_ISR(169);
	SET_GATE_ISR(170);
	SET_GATE_ISR(171);
	SET_GATE_ISR(172);
	SET_GATE_ISR(173);
	SET_GATE_ISR(174);
	SET_GATE_ISR(175);
	SET_GATE_ISR(176);
	SET_GATE_ISR(177);
	SET_GATE_ISR(178);
	SET_GATE_ISR(179);
	SET_GATE_ISR(180);
	SET_GATE_ISR(181);
	SET_GATE_ISR(182);
	SET_GATE_ISR(183);
	SET_GATE_ISR(184);
	SET_GATE_ISR(185);
	SET_GATE_ISR(186);
	SET_GATE_ISR(187);
	SET_GATE_ISR(188);
	SET_GATE_ISR(189);
	SET_GATE_ISR(190);
	SET_GATE_ISR(191);
	SET_GATE_ISR(192);
	SET_GATE_ISR(193);
	SET_GATE_ISR(194);
	SET_GATE_ISR(195);
	SET_GATE_ISR(196);
	SET_GATE_ISR(197);
	SET_GATE_ISR(198);
	SET_GATE_ISR(199);
	SET_GATE_ISR(200);
	SET_GATE_ISR(201);
	SET_GATE_ISR(202);
	SET_GATE_ISR(203);
	SET_GATE_ISR(204);
	SET_GATE_ISR(205);
	SET_GATE_ISR(206);
	SET_GATE_ISR(207);
	SET_GATE_ISR(208);
	SET_GATE_ISR(209);
	SET_GATE_ISR(210);
	SET_GATE_ISR(211);
	SET_GATE_ISR(212);
	SET_GATE_ISR(213);
	SET_GATE_ISR(214);
	SET_GATE_ISR(215);
	SET_GATE_ISR(216);
	SET_GATE_ISR(217);
	SET_GATE_ISR(218);
	SET_GATE_ISR(219);
	SET_GATE_ISR(220);
	SET_GATE_ISR(221);
	SET_GATE_ISR(222);
	SET_GATE_ISR(223);
	SET_GATE_ISR(224);
	SET_GATE_ISR(225);
	SET_GATE_ISR(226);
	SET_GATE_ISR(227);
	SET_GATE_ISR(228);
	SET_GATE_ISR(229);
	SET_GATE_ISR(230);
	SET_GATE_ISR(231);
	SET_GATE_ISR(232);
	SET_GATE_ISR(233);
	SET_GATE_ISR(234);
	SET_GATE_ISR(235);
	SET_GATE_ISR(236);
	SET_GATE_ISR(237);
	SET_GATE_ISR(238);
	SET_GATE_ISR(239);
	SET_GATE_ISR(240);
	SET_GATE_ISR(241);
	SET_GATE_ISR(242);
	SET_GATE_ISR(243);
	SET_GATE_ISR(244);
	SET_GATE_ISR(245);
	SET_GATE_ISR(246);
	SET_GATE_ISR(247);
	SET_GATE_ISR(248);
	SET_GATE_ISR(249);
	SET_GATE_ISR(250);
	SET_GATE_ISR(251);
	SET_GATE_ISR(252);
	SET_GATE_ISR(253);
	SET_GATE_ISR(254);
	SET_GATE_ISR(255);

	idt_flush((uint32_t)&get_core_locals()->idt_entries_ptr);
}